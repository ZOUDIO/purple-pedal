/dts-v1/;
#include <st/g0/stm32g0b0Xe.dtsi>
#include <st/g0/stm32g0b0cetx-pinctrl.dtsi>
// #include <st/g0/stm32g0b1Xe.dtsi>
// #include <st/g0/stm32g0b1r(b-c-e)tx-pinctrl.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>

//#include <zephyr/dt-bindings/clock/stm32g0_b1x_c1x_clock.h>
//change to STM32G0B0CET6 

/ {
	model = "Purple pedal board";
	compatible = "zoudio,purple_pedal";

	chosen {
		zephyr,console = &usart2;
		zephyr,shell-uart = &usart2;
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
        //zephyr,uart-mcumgr = &cdc_acm_uart0;
        zephyr,code-partition = &slot0_partition;
	};

	// clocks {
	// 	clk_hsi48: clk-hsi48 {
	// 		#clock-cells = <0>;
	// 		compatible = "st,stm32-hsi48-clock";
	// 		clock-frequency = <DT_FREQ_M(48)>;
	// 		status = "okay";
	// 	};
	// };

	leds: leds {
		compatible = "gpio-leds";

		green_led_1: led_1 {
			gpios = <&gpiob 4 GPIO_ACTIVE_HIGH>;
			label = "User LD1";
		};

		// blue_led: led_2 {
		// 	gpios = <&gpioc 9 GPIO_ACTIVE_HIGH>;
		// 	label = "User LD2";
		// };
	};
	pwm_leds_rgb: pwm3leds {
		compatible = "pwm-leds";
		status = "okay";
		pwm_led_r: pwm_led_r {
			pwms = <&pwm3 2 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
		pwm_led_g: pwm_led_g {
			pwms = <&pwm3 4 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
		pwm_led_b: pwm_led_b {
			pwms = <&pwm3 3 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
	};

	pwm_leds_pedal: pwm1leds {
		compatible = "pwm-leds";
		status = "okay";
		pwm_led_0: pwm_led_0 {
			pwms = <&pwm1 1 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
		pwm_led_1: pwm_led_1 {
			pwms = <&pwm1 2 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
		pwm_led_2: pwm_led_2 {
			pwms = <&pwm1 3 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
	};

	// gpio_keys {
	// 	compatible = "gpio-keys";

	// 	user_button: button {
	// 		label = "user button";
	// 		gpios = <&gpioc 13 GPIO_ACTIVE_LOW>;
	// 		status = "okay";
	// 		zephyr,code = <INPUT_KEY_0>;
	// 	};
	// };

	aliases {
		led0 = &green_led_1;
		// led1 = &blue_led;
		//pwm-led0 = &green_pwm_led;
		//sw0 = &user_button;
		watchdog0 = &iwdg;
		die-temp0 = &die_temp;
		volt-sensor0 = &vref;
	};
};

//use internal 16MHz RC oscillator
// &clk_hsi {
// 	status = "okay";
// };

&clk_hse {
	clock-frequency = <DT_FREQ_M(8)>;
	status = "okay";
};

// &clk_lsi {
// 	status = "okay";
// };

// &pll {
// 	div-m = <1>;
// 	mul-n = <12>;// 16x12=192MHz
// 	div-p = <2>;
// 	div-q = <4>; // PLL/Q=48MHz
// 	div-r = <3>; // PLL/R=64MHz
// 	clocks = <&clk_hsi>;
// 	status = "okay";
// };

&pll {
	div-m = <1>;
	mul-n = <12>;// 8x24=192MHz
	div-p = <2>;
	div-q = <2>; // PLL/Q=48MHz
	div-r = <2>; // PLL/R=64MHz
	clocks = <&clk_hse>;
	status = "okay";
};

&rcc {
	clocks = <&pll>;
	clock-frequency = <DT_FREQ_M(48)>;
	ahb-prescaler = <1>;
	apb1-prescaler = <1>;
};


&usart2 {
	pinctrl-0 = <&usart2_tx_pa2 &usart2_rx_pa3>;
	pinctrl-names = "default";
	current-speed = <115200>;
	status = "okay";
};

&spi2 {
	pinctrl-0 = <&spi2_nss_pb9 &spi2_sck_pb8
		     &spi2_miso_pb6 &spi2_mosi_pb7>;
	pinctrl-names = "default";
    cs-gpios = <&gpiob 9 GPIO_ACTIVE_LOW>;
	status = "okay";
    adc_ad7124: ad7124@0 {
	    compatible = "adi,ad7124-adc";
	    reg = <0x0>;
	    spi-max-frequency = <8000000>;
	    #io-channel-cells = <1>;
	    active-device = <0>; //0 ID_AD7124_4, 1 ID_AD7124_8
        status = "okay";
    };
};

&usb_dm_pa11 {
	slew-rate = "medium-speed";
};

&usb_dp_pa12 {
	slew-rate = "medium-speed";
};

zephyr_udc0: &usb {
	pinctrl-0 = <&usb_dm_pa11 &usb_dp_pa12>;
	pinctrl-names = "default";
	clocks = <&rcc STM32_CLOCK(APB1, 13)>,
				 <&rcc STM32_SRC_PLL_Q USB_SEL(2)>;//not sure why, but USB_SEL(2) makes USB working
	//maximum-speed = "low-speed";
	//vbus-gpios = <&gpiob 5 GPIO_ACTIVE_HIGH>;
	// interrupts = <16 0>;
	// num-bidir-endpoints = <16>;
	// ram-size = <8192>;
	status = "okay";
};

&timers1 {
	status = "okay";
	st,prescaler = <10000>;
	pwm1: pwm{
		status = "okay";
		pinctrl-0 = <&tim1_ch1_pa8 &tim1_ch2_pa9 &tim1_ch3_pa10>;
		pinctrl-names = "default";
	};
};

&timers3 {
	status = "okay";
	st,prescaler = <10000>;
	pwm3: pwm{
		status = "okay";
		pinctrl-0 = <&tim3_ch2_pa7 &tim3_ch3_pb0 &tim3_ch4_pb1>;
		pinctrl-names = "default";
	};
};

&flash0 {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		boot_partition: partition@0 {
			label = "mcuboot";
			reg = <0x00000000 DT_SIZE_K(48)>;
			read-only;
		};

		slot0_partition: partition@C000 {
			label = "image-0";
			reg = <0x0000C000 DT_SIZE_K(200)>;
		};

		slot1_partition: partition@3E000 {
			label = "image-1";
			reg = <0x0003E000 DT_SIZE_K(200)>;
		};

		/* final 64KiB reserved for app storage partition */
		storage_partition: partition@70000 {
			label = "storage";
			reg = <0x00070000 DT_SIZE_K(64)>;
		};
	};
};